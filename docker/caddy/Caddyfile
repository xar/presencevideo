# =============================================================================
# Caddy Configuration for Laravel + PHP-FPM
# Optimized for production deployment
# =============================================================================

{
    # Disable admin API in production
    admin off

    # Persist OCSP stapling data
    persist_config off

    # Logging format
    log {
        format json
        output stdout
    }

    # Auto HTTPS disabled (handled by Coolify/reverse proxy)
    auto_https off
}

# Main site configuration
:8000 {
    # Root directory
    root * /var/www/html/public

    # Enable gzip compression
    encode {
        gzip
        zstd
        minimum_length 256
    }

    # Security headers
    header {
        # Prevent clickjacking
        X-Frame-Options "SAMEORIGIN"

        # XSS protection
        X-Content-Type-Options "nosniff"
        X-XSS-Protection "1; mode=block"

        # Referrer policy
        Referrer-Policy "strict-origin-when-cross-origin"

        # Remove server identification
        -Server
        -X-Powered-By
    }

    # Health check endpoint - use Laravel's /up route for proper checks
    # This ensures database connectivity is verified

    # Static asset caching
    @static {
        path *.css *.js *.ico *.gif *.jpg *.jpeg *.png *.svg *.webp *.woff *.woff2
    }
    header @static {
        Cache-Control "public, max-age=31536000, immutable"
    }

    # Vite build assets (immutable)
    @vite {
        path /build/*
    }
    header @vite {
        Cache-Control "public, max-age=31536000, immutable"
    }

    # Block access to sensitive files
    @blocked {
        path /.* /composer.* /package*.json /webpack.* /vite.* /*.md /phpunit.* /artisan
    }
    respond @blocked 404

    # Storage symlink
    @storage {
        path /storage/*
    }
    file_server @storage {
        root /var/www/html
    }

    # PHP files handling via FastCGI
    php_fastcgi 127.0.0.1:9000 {
        # Increase timeouts for long-running requests
        read_timeout 120s
        write_timeout 120s

        # Trust proxy headers from Traefik (Docker network)
        trusted_proxies private_ranges

        # Pass proper scheme from Traefik's X-Forwarded-Proto
        env HTTPS {header.X-Forwarded-Proto}

        # Split path for Laravel routing
        split .php

        # Index file
        index index.php
    }

    # Serve static files, fallback to index.php (Laravel routing)
    try_files {path} {path}/ /index.php?{query}

    file_server

    # Logging
    log {
        output stdout
        format json {
            time_format iso8601
        }
        level INFO
    }
}
