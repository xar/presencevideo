[www]
; =============================================================================
; PHP-FPM Pool Configuration for Production
; =============================================================================

; Process user/group - must match app ownership
user = www
group = www

; Listen on TCP socket for Caddy/Nginx reverse proxy
listen = 127.0.0.1:9000
listen.owner = www
listen.group = www
listen.mode = 0660

; Process Manager Configuration
; 'dynamic' adjusts worker count based on demand (recommended for production)
pm = dynamic

; Maximum number of child processes
; Rule of thumb: (Total RAM - Reserved for OS) / Memory per PHP process
; For 2GB RAM server: (2048 - 512) / 30 = ~50 children
pm.max_children = 50

; Number of processes to start initially
; Should be ~25% of max_children for warm start
pm.start_servers = 12

; Minimum spare idle processes
; Keep enough warm processes to handle sudden traffic spikes
pm.min_spare_servers = 8

; Maximum spare idle processes
; Don't keep too many idle processes (wastes RAM)
pm.max_spare_servers = 20

; Number of requests after which a worker respawns
; Prevents memory leaks from accumulating
pm.max_requests = 500

; Time limit for child processes to terminate gracefully
process.durable = no

; =============================================================================
; Request handling
; =============================================================================

; Maximum execution time per request (seconds)
; Should match PHP's max_execution_time
request_terminate_timeout = 120s

; Slow log threshold (seconds) - useful for finding bottlenecks
request_slowlog_timeout = 10s
slowlog = /var/log/php-fpm/slow.log

; =============================================================================
; Security
; =============================================================================

; Restrict to single app directory
chdir = /var/www/html

; Security: Don't expose PHP version
php_admin_flag[expose_php] = off

; Note: Most functions enabled for Laravel (FFmpeg, Horizon, queues)
; Only disable truly dangerous functions that should never be used
php_admin_value[disable_functions] = dl

; Don't clear environment variables (needed for Docker env vars)
clear_env = no

; =============================================================================
; Logging
; =============================================================================

; Send access log to stdout for Docker
access.log = /dev/stdout
access.format = "%R - %u %t \"%m %r%Q%q\" %s %f %{mili}d %{kilo}M %C%%"

; Send errors to stderr
catch_workers_output = yes
decorate_workers_output = no

; Enable error logging
php_admin_flag[log_errors] = on
php_admin_value[error_log] = /dev/stderr

; =============================================================================
; PHP Settings (can be overridden via env vars in main config)
; =============================================================================

; Session configuration for production
php_value[session.save_handler] = files
php_value[session.save_path] = /var/www/html/storage/framework/sessions

; Temporary files
php_value[upload_tmp_dir] = /tmp
php_value[sys_temp_dir] = /tmp

; OPcache settings for production
php_admin_value[opcache.enable] = 1
php_admin_value[opcache.validate_timestamps] = 0
php_admin_value[opcache.memory_consumption] = 256
php_admin_value[opcache.interned_strings_buffer] = 32
php_admin_value[opcache.max_accelerated_files] = 20000
php_admin_value[opcache.jit] = tracing
php_admin_value[opcache.jit_buffer_size] = 64M

; Realpath cache for faster file operations
php_admin_value[realpath_cache_size] = 4096K
php_admin_value[realpath_cache_ttl] = 600
